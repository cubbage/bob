<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Object Editor - bob.json</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, Segoe UI, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: #007aff;
      color: white;
      padding: 20px;
      text-align: center;
    }

    .header h1 {
      margin: 0;
      font-size: 24px;
    }

    .controls {
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .object-info {
      padding: 20px;
      border-bottom: 1px solid #eee;
    }

    .object-properties {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .property-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .property-group label {
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .property-group input,
    .property-group select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .property-group input:focus,
    .property-group select:focus {
      outline: none;
      border-color: #007aff;
      box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
    }

    .color-picker {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .color-picker input[type="color"] {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: #007aff;
      color: white;
    }

    .btn-primary:hover {
      background: #0056b3;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #545b62;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #1e7e34;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .grid-container {
      position: relative;
      width: 100%;
      height: 500px;
      background:
        linear-gradient(rgba(0, 0, 0, 0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 0, 0, 0.1) 1px, transparent 1px);
      background-size: 20px 20px;
      border: 2px solid #ddd;
      border-radius: 8px;
      margin: 20px;
      overflow: hidden;
      cursor: crosshair;
    }

    .grid-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .grid-coordinates {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      pointer-events: none;
    }

    .positioned-object {
      position: absolute;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 14px;
      cursor: move;
      user-select: none;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.2s ease;
      min-width: 60px;
      text-align: center;
    }

    .positioned-object:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .positioned-object.selected {
      outline: 3px solid #007aff;
      outline-offset: 2px;
    }

    .object-counter {
      background: #f8f9fa;
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .object-counter span {
      font-weight: 600;
      color: #333;
    }

    .navigation-buttons {
      display: flex;
      gap: 10px;
    }

    .save-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 10px 15px;
      border-radius: 6px;
      font-weight: 600;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1000;
    }

    .save-indicator.show {
      opacity: 1;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 6px;
      margin: 20px;
      border: 1px solid #f5c6cb;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: #28a745;
    }

    input:checked+.slider:before {
      transform: translateX(26px);
    }

    .enabled-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .enabled-indicator span {
      font-size: 14px;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>Object Editor</h1>
      <p>Edit objects from bob.json with coordinate positioning</p>
    </div>

    <div class="loading" id="loading">
      Loading objects from bob.json...
    </div>

    <div class="error" id="error" style="display: none;">
      Error loading bob.json. Please make sure the file exists and is valid JSON.
    </div>

    <div id="main-content" style="display: none;">
      <div class="object-counter">
        <span id="object-counter-text">Object 1 of 0</span>
        <div class="navigation-buttons">
          <button class="btn btn-secondary" id="prev-btn">← Previous</button>
          <button class="btn btn-secondary" id="next-btn">Next →</button>
        </div>
      </div>

      <div class="object-info">
        <div class="object-properties">
          <div class="property-group">
            <label for="label">Label</label>
            <input type="text" id="label" placeholder="Object label">
          </div>

          <div class="property-group">
            <label for="match">Match Pattern</label>
            <input type="text" id="match" placeholder="regex pattern">
          </div>

          <div class="property-group">
            <label for="group">Group</label>
            <input type="text" id="group" placeholder="group name">
          </div>

          <div class="property-group">
            <label for="color1">Color 1</label>
            <div class="color-picker">
              <input type="text" id="color1" placeholder="#ff0000">
              <input type="color" id="color1-picker" value="#ff0000">
            </div>
          </div>

          <div class="property-group">
            <label for="color2">Color 2</label>
            <div class="color-picker">
              <input type="text" id="color2" placeholder="#ffffff">
              <input type="color" id="color2-picker" value="#ffffff">
            </div>
          </div>

          <div class="property-group">
            <label for="style1">Style 1</label>
            <select id="style1">
              <option value="">None</option>
              <option value="background">Background</option>
              <option value="color">Text Color</option>
              <option value="underline">Underline</option>
              <option value="border">Border</option>
              <option value="symbol">Symbol</option>
            </select>
          </div>

          <div class="property-group">
            <label for="style2">Style 2</label>
            <select id="style2">
              <option value="">None</option>
              <option value="background">Background</option>
              <option value="color">Text Color</option>
              <option value="underline">Underline</option>
              <option value="border">Border</option>
              <option value="symbol">Symbol</option>
            </select>
          </div>

          <div class="property-group">
            <label>Enabled</label>
            <div class="enabled-indicator">
              <label class="toggle-switch">
                <input type="checkbox" id="enabled">
                <span class="slider"></span>
              </label>
              <span id="enabled-text">Enabled</span>
            </div>
          </div>
        </div>

        <div class="controls">
          <button class="btn btn-primary" id="save-btn">Save Changes</button>
          <button class="btn btn-secondary" id="reset-btn">Reset to Original</button>
          <button class="btn btn-success" id="export-btn">Export to bob.json</button>
          <button class="btn btn-danger" id="delete-btn">Delete Object</button>
        </div>
      </div>

      <div class="grid-container" id="grid-container">
        <div class="grid-coordinates" id="coordinates">X: 0, Y: 0</div>
        <div class="grid-overlay" id="grid-overlay"></div>
      </div>
    </div>
  </div>

  <div class="save-indicator" id="save-indicator">✓ Saved</div>

  <script>
    // Global variables
    let objects = [];
    let currentIndex = 0;
    let originalObjects = [];
    let isDragging = false;
    let draggedElement = null;
    let dragOffset = { x: 0, y: 0 };

    // Load objects from bob.json
    async function loadObjects() {
      try {
        const response = await fetch('bob.json');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();

        if (data.objectsData && data.objectsData.objects) {
          objects = data.objectsData.objects.map(obj => ({
            ...obj,
            x: obj.x || Math.floor(Math.random() * 400) + 50,
            y: obj.y || Math.floor(Math.random() * 300) + 50
          }));
          originalObjects = JSON.parse(JSON.stringify(objects));

          document.getElementById('loading').style.display = 'none';
          document.getElementById('main-content').style.display = 'block';

          if (objects.length > 0) {
            displayCurrentObject();
          } else {
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').textContent = 'No objects found in bob.json';
          }
        } else {
          throw new Error('No objects found in bob.json');
        }
      } catch (error) {
        console.error('Error loading objects:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').textContent = `Error loading bob.json: ${error.message}`;
      }
    }

    // Display current object
    function displayCurrentObject() {
      if (objects.length === 0) return;

      const obj = objects[currentIndex];

      // Update form fields
      document.getElementById('label').value = obj.label || '';
      document.getElementById('match').value = obj.match || '';
      document.getElementById('group').value = obj.group || '';
      document.getElementById('color1').value = obj.color1 || '';
      document.getElementById('color2').value = obj.color2 || '';
      document.getElementById('style1').value = obj.style1 || '';
      document.getElementById('style2').value = obj.style2 || '';
      document.getElementById('enabled').checked = obj.enabled !== false;

      // Update color pickers
      if (obj.color1 && obj.color1.match(/^#[0-9A-Fa-f]{6}$/)) {
        document.getElementById('color1-picker').value = obj.color1;
      }
      if (obj.color2 && obj.color2.match(/^#[0-9A-Fa-f]{6}$/)) {
        document.getElementById('color2-picker').value = obj.color2;
      }

      // Update counter
      document.getElementById('object-counter-text').textContent = `Object ${currentIndex + 1} of ${objects.length}`;

      // Update navigation buttons
      document.getElementById('prev-btn').disabled = currentIndex === 0;
      document.getElementById('next-btn').disabled = currentIndex === objects.length - 1;

      // Update grid
      updateGrid();
    }

    // Update the grid with positioned objects
    function updateGrid() {
      const overlay = document.getElementById('grid-overlay');
      overlay.innerHTML = '';

      objects.forEach((obj, index) => {
        const element = document.createElement('div');
        element.className = 'positioned-object';
        element.textContent = obj.label || 'Unnamed';
        element.style.left = `${obj.x}px`;
        element.style.top = `${obj.y}px`;

        // Apply styling based on object properties
        if (obj.color1 && obj.style1) {
          applyStyleToElement(element, obj.color1, obj.style1);
        }
        if (obj.color2 && obj.style2 && obj.style2 !== obj.style1) {
          applyStyleToElement(element, obj.color2, obj.style2);
        }

        // Highlight current object
        if (index === currentIndex) {
          element.classList.add('selected');
        }

        // Add drag functionality
        element.addEventListener('mousedown', (e) => {
          if (index === currentIndex) {
            startDrag(e, element, obj, index);
          }
        });

        overlay.appendChild(element);
      });
    }

    // Apply style to element
    function applyStyleToElement(element, color, style) {
      try {
        switch (style) {
          case 'background':
            element.style.backgroundColor = color;
            element.style.color = getContrastColor(color);
            break;
          case 'color':
            element.style.color = color;
            break;
          case 'underline':
            element.style.textDecoration = `underline ${color}`;
            break;
          case 'border':
            element.style.border = `2px solid ${color}`;
            break;
          case 'symbol':
            // Add emoji based on group
            const emoji = getGroupEmoji(element.textContent);
            if (emoji && !element.textContent.startsWith(emoji)) {
              element.textContent = emoji + ' ' + element.textContent;
            }
            break;
        }
      } catch (e) {
        console.warn('Error applying style:', e);
      }
    }

    // Get contrast color
    function getContrastColor(color) {
      if (color.startsWith('#')) {
        const hex = color.replace('#', '');
        if (hex.length === 6) {
          const r = parseInt(hex.substr(0, 2), 16);
          const g = parseInt(hex.substr(2, 2), 16);
          const b = parseInt(hex.substr(4, 2), 16);
          const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
          return luminance > 0.5 ? '#000000' : '#ffffff';
        }
      }
      return '#000000';
    }

    // Get group emoji (simplified version)
    function getGroupEmoji(groupName) {
      const emojiMap = {
        'color': '🎨',
        'day of the week': '📅',
        'instrument': '🎸',
        'letter': '🅰️',
        'month': '📆',
        'number': '🔢',
        'person': '👤',
        'shape': '⭐',
        'sound': '🔊',
        'texture': '🧶',
        'school subject': '🎓',
        'colorality': '🩶'
      };
      return emojiMap[groupName] || '';
    }

    // Drag functionality
    function startDrag(e, element, obj, index) {
      isDragging = true;
      draggedElement = element;

      const rect = element.getBoundingClientRect();
      const gridRect = document.getElementById('grid-container').getBoundingClientRect();

      dragOffset.x = e.clientX - rect.left;
      dragOffset.y = e.clientY - rect.top;

      document.addEventListener('mousemove', handleDrag);
      document.addEventListener('mouseup', stopDrag);

      e.preventDefault();
    }

    function handleDrag(e) {
      if (!isDragging || !draggedElement) return;

      const gridRect = document.getElementById('grid-container').getBoundingClientRect();
      const x = e.clientX - gridRect.left - dragOffset.x;
      const y = e.clientY - gridRect.top - dragOffset.y;

      // Constrain to grid bounds
      const maxX = gridRect.width - draggedElement.offsetWidth;
      const maxY = gridRect.height - draggedElement.offsetHeight;

      const constrainedX = Math.max(0, Math.min(x, maxX));
      const constrainedY = Math.max(0, Math.min(y, maxY));

      draggedElement.style.left = `${constrainedX}px`;
      draggedElement.style.top = `${constrainedY}px`;

      // Update coordinates display
      document.getElementById('coordinates').textContent = `X: ${Math.round(constrainedX)}, Y: ${Math.round(constrainedY)}`;
    }

    function stopDrag() {
      if (isDragging && draggedElement) {
        const x = parseInt(draggedElement.style.left);
        const y = parseInt(draggedElement.style.top);

        // Update current object position
        objects[currentIndex].x = x;
        objects[currentIndex].y = y;

        isDragging = false;
        draggedElement = null;

        document.removeEventListener('mousemove', handleDrag);
        document.removeEventListener('mouseup', stopDrag);

        showSaveIndicator();
      }
    }

    // Grid click handler
    document.getElementById('grid-container').addEventListener('click', (e) => {
      if (isDragging) return;

      const gridRect = e.currentTarget.getBoundingClientRect();
      const x = e.clientX - gridRect.left;
      const y = e.clientY - gridRect.top;

      // Update current object position
      objects[currentIndex].x = x;
      objects[currentIndex].y = y;

      // Update coordinates display
      document.getElementById('coordinates').textContent = `X: ${Math.round(x)}, Y: ${Math.round(y)}`;

      // Update grid
      updateGrid();

      showSaveIndicator();
    });

    // Form change handlers
    document.getElementById('label').addEventListener('input', updateCurrentObject);
    document.getElementById('match').addEventListener('input', updateCurrentObject);
    document.getElementById('group').addEventListener('input', updateCurrentObject);
    document.getElementById('color1').addEventListener('input', updateCurrentObject);
    document.getElementById('color2').addEventListener('input', updateCurrentObject);
    document.getElementById('style1').addEventListener('change', updateCurrentObject);
    document.getElementById('style2').addEventListener('change', updateCurrentObject);
    document.getElementById('enabled').addEventListener('change', updateCurrentObject);

    // Color picker sync
    document.getElementById('color1-picker').addEventListener('input', (e) => {
      document.getElementById('color1').value = e.target.value;
      updateCurrentObject();
    });

    document.getElementById('color2-picker').addEventListener('input', (e) => {
      document.getElementById('color2').value = e.target.value;
      updateCurrentObject();
    });

    function updateCurrentObject() {
      if (objects.length === 0) return;

      const obj = objects[currentIndex];
      obj.label = document.getElementById('label').value;
      obj.match = document.getElementById('match').value;
      obj.group = document.getElementById('group').value;
      obj.color1 = document.getElementById('color1').value;
      obj.color2 = document.getElementById('color2').value;
      obj.style1 = document.getElementById('style1').value;
      obj.style2 = document.getElementById('style2').value;
      obj.enabled = document.getElementById('enabled').checked;

      updateGrid();
      showSaveIndicator();
    }

    // Navigation handlers
    document.getElementById('prev-btn').addEventListener('click', () => {
      if (currentIndex > 0) {
        currentIndex--;
        displayCurrentObject();
      }
    });

    document.getElementById('next-btn').addEventListener('click', () => {
      if (currentIndex < objects.length - 1) {
        currentIndex++;
        displayCurrentObject();
      }
    });

    // Action handlers
    document.getElementById('save-btn').addEventListener('click', () => {
      updateCurrentObject();
      showSaveIndicator();
    });

    document.getElementById('reset-btn').addEventListener('click', () => {
      if (confirm('Reset current object to original values?')) {
        objects[currentIndex] = JSON.parse(JSON.stringify(originalObjects[currentIndex]));
        displayCurrentObject();
        showSaveIndicator();
      }
    });

    document.getElementById('export-btn').addEventListener('click', () => {
      exportToBobJson();
    });

    document.getElementById('delete-btn').addEventListener('click', () => {
      if (confirm('Delete this object? This action cannot be undone.')) {
        objects.splice(currentIndex, 1);
        originalObjects.splice(currentIndex, 1);

        if (objects.length === 0) {
          document.getElementById('main-content').style.display = 'none';
          document.getElementById('error').style.display = 'block';
          document.getElementById('error').textContent = 'No objects remaining';
          return;
        }

        if (currentIndex >= objects.length) {
          currentIndex = objects.length - 1;
        }

        displayCurrentObject();
        showSaveIndicator();
      }
    });

    function showSaveIndicator() {
      const indicator = document.getElementById('save-indicator');
      indicator.classList.add('show');
      setTimeout(() => {
        indicator.classList.remove('show');
      }, 2000);
    }

    function exportToBobJson() {
      try {
        // Create the full bob.json structure
        const exportData = {
          defaultPattern: {
            label: "instrument",
            color1: "#757575",
            color2: "#ebebeb",
            structure: {
              startAnchor: false,
              startWordBoundary: false,
              customPrependToggles: [],
              basePattern: ".*",
              customAppendToggles: [],
              endWordBoundary: false,
              endAnchor: false
            },
            style1: "color",
            style2: "background"
          },
          dictionary: {
            rules: [
              {
                match: "",
                color1: "#A9CCE3",
                color2: "",
                style1: "background",
                style2: "background",
                label: "person",
                enabled: true
              }
            ]
          },
          listsData: {
            keyValueLists: [
              {
                name: "categories",
                items: [
                  { key: "color", value: "🎨" },
                  { key: "day of the week", value: "📅" },
                  { key: "instrument", value: "🎸" },
                  { key: "letter", value: "🅰️" },
                  { key: "month", value: "📆" },
                  { key: "number", value: "🔢" },
                  { key: "person", value: "👤" },
                  { key: "shape", value: "⭐" },
                  { key: "sound", value: "🔊" },
                  { key: "texture", value: "🧶" },
                  { key: "school subject", value: "🎓" },
                  { key: "colorality", value: "🩶" }
                ]
              }
            ],
            arrays: [
              {
                name: "list",
                items: [
                  "colors",
                  "days of the week",
                  "instruments",
                  "months",
                  "people",
                  "sounds"
                ]
              }
            ]
          },
          objectsData: {
            objects: objects
          }
        };

        // Create and download the file
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'bob.json';
        a.click();

        showSaveIndicator();
      } catch (error) {
        console.error('Error exporting:', error);
        alert('Error exporting to bob.json');
      }
    }

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft' && currentIndex > 0) {
        currentIndex--;
        displayCurrentObject();
      } else if (e.key === 'ArrowRight' && currentIndex < objects.length - 1) {
        currentIndex++;
        displayCurrentObject();
      }
    });

    // Initialize
    loadObjects();
  </script>
</body>

</html>